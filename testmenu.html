<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Menu Upload Dummy — With Parsing</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { color: #333; }
    form { margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #bbb; padding: 8px; text-align: left; }
    th { background-color: #eee; }
    #status { margin-top: 20px; color: green; }
    #error { margin-top: 20px; color: red; }
  </style>
</head>
<body>

  <h1>Upload Menu Image / PDF</h1>
  <form id="uploadForm">
    <input type="file" id="menuFile" accept="image/*,application/pdf" />
    <button type="submit">Upload & Process</button>
  </form>

  <h2>Existing Categories</h2>
  <table id="categoriesTable">
    <thead>
      <tr><th>ID</th><th>Name</th><th>Description</th></tr>
    </thead>
    <tbody>
      <!-- dummy categories -->
      <tr><td>1111-aaaa</td><td>Appetizers</td><td>Starters and small plates</td></tr>
      <tr><td>2222-bbbb</td><td>Main</td><td>Main courses</td></tr>
      <tr><td>3333-cccc</td><td>Dessert</td><td>Sweets & after meals</td></tr>
    </tbody>
  </table>

  <h2>Items</h2>
  <table id="itemsTable">
    <thead>
      <tr><th>Category</th><th>Name</th><th>Price</th></tr>
    </thead>
    <tbody>
      <!-- will fill with response -->
    </tbody>
  </table>

  <div id="status"></div>
  <div id="error"></div>

  <script>
    const form = document.getElementById('uploadForm');
    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error');
    const itemsTableBody = document.querySelector('#itemsTable tbody');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusDiv.textContent = '';
      errorDiv.textContent = '';
      itemsTableBody.innerHTML = '';  // clear previous items

      const fileInput = document.getElementById('menuFile');
      const file = fileInput.files[0];
      if (!file) {
        errorDiv.textContent = 'Please select a file first.';
        return;
      }

      // gather existing categories (if needed)
      const cats = [];
      const catRows = document.querySelectorAll('#categoriesTable tbody tr');
      catRows.forEach(r => {
        const cols = r.querySelectorAll('td');
        const id = cols[0].textContent.trim();
        const name = cols[1].textContent.trim();
        const description = cols[2].textContent.trim();
        cats.push({ id, name, description });
      });

      const formData = new FormData();
      formData.append('file', file);
      formData.append('categories', JSON.stringify(cats));

      try {
        const resp = await fetch('https://YOUR_N8N_WEBHOOK_URL_HERE', {
          method: 'POST',
          body: formData
        });
        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error('Webhook call failed: ' + txt);
        }
        const json = await resp.json();

        // Example json: [ { "output": "```json\n{ \"menu\": { \"APPETIZERS AND SNACKS\": [ { \"item\": \"Mozzarella Sticks\", \"price\": 7 }, … ] } }```" } ]
        // extract the JSON between the ```json ... ``` markers, or try to parse directly
        const out = json[0]?.output;
        if (!out) {
          throw new Error("No output field in response");
        }
        // strip code fences if present
        let cleaned = out.trim();
        // remove starting ```json and ending ```
        if (cleaned.startsWith("```json")) {
          cleaned = cleaned.slice("```json".length).trim();
        }
        if (cleaned.endsWith("```")) {
          cleaned = cleaned.slice(0, cleaned.length - 3).trim();
        }
        // now cleaned should be a JSON string
        let parsed;
        try {
          parsed = JSON.parse(cleaned);
        } catch (parseErr) {
          console.error("Parse error:", parseErr, cleaned);
          throw new Error("Unable to parse JSON output from agent");
        }

        // parsed.menu is presumably an object whose keys are category names, values are arrays of items
        const menu = parsed.menu || {};
        for (const [categoryName, items] of Object.entries(menu)) {
          if (!Array.isArray(items)) continue;
          items.forEach(it => {
            const tr = document.createElement('tr');
            const tdCat = document.createElement('td');
            const tdName = document.createElement('td');
            const tdPrice = document.createElement('td');

            tdCat.textContent = categoryName;
            tdName.textContent = it.item || '';
            tdPrice.textContent = (it.price !== undefined && it.price !== null) ? it.price : '';

            tr.appendChild(tdCat);
            tr.appendChild(tdName);
            tr.appendChild(tdPrice);
            itemsTableBody.appendChild(tr);
          });
        }

        statusDiv.textContent = 'Success!';
      } catch (err) {
        console.error(err);
        errorDiv.textContent = 'Error: ' + err.message;
      }
    });
  </script>

</body>
</html>
